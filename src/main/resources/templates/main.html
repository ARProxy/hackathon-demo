<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>메인 페이지 - 내 지역 재난지원금 찾기</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <style>
        body {
            background-color: #121212;
            color: #fff;
            max-width: 420px;
            margin: 0 auto;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            font-family: 'Noto Sans KR', sans-serif;
        }
        header {
            display:flex; justify-content:space-between; align-items:center;
            padding: 1rem;
            border-bottom:1px solid #1e1e1e;
            background-color: #121212;
            position: sticky; top: 0; z-index: 1000;
        }
        .logo { font-size:1.3rem; font-weight:bold; color:#0d6efd; }
        .user-info { display:flex; align-items:center; }
        .user-info img { width:32px; height:32px; border-radius:50%; margin-right:8px; border: 1px solid #333; }
        .user-info span { font-size:0.95rem; font-weight:500; color:#fff; }

        .main-content {
            flex: 1;
            padding: 1.5rem 1rem;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* 검색박스와 결과카드 크기/스타일 통일 */
        .search-box,
        .result-card {
            width: 100%;
            background: #1e1e1e;
            border-radius: 12px;
            padding: 1.2rem;
            box-shadow: 0 2px 8px rgba(0,0,0,.4);
            margin-bottom: 0.3rem; /* 아래쪽 간격만 */
            box-sizing: border-box; /* 패딩 포함 계산 */
        }
        .search-box { text-align: center; margin-bottom: 0.8rem; }

        .search-box h2 { font-size: 1.2rem; margin-bottom: 0.5rem; font-weight: 700; color: #fff; }
        .search-box p { font-size: 0.9rem; margin-bottom: 1rem; color: #bbb; }

        .input-group { display: flex; gap: 8px; margin-bottom: 1rem; }
        .form-control {
            flex: 1; padding: 0.6rem; border-radius: 8px; border: none;
            background: #2a2a2a; color: #fff; font-size: 0.95rem;
        }
        .form-control::placeholder { color: #666; }
        .btn { border: none; border-radius: 8px; padding: 0.6rem 1rem; font-size: 0.95rem; font-weight: 600; cursor: pointer; }
        .btn-primary { background-color: #0d6efd; color: #fff; width: 100%; }
        .btn-outline-secondary { background: #2a2a2a; color: #bbb; }
        .btn-outline-secondary:hover { background:#333; color:#fff; }

        .results-container { margin-top: 1.5rem; width:100%; }

        /* 카드 등장 애니메이션 (느리게) */
        @keyframes fadeInDown {
            from { opacity: 0; transform: translateY(-20px); }
            to   { opacity: 1; transform: translateY(0); }
        }
        .result-card {
            text-align: left;
            opacity: 0; /* 등장 전 숨김 */
            position: relative;
            cursor: pointer; /* 카드 클릭 가능 */
        }
        .result-card.show { animation: fadeInDown 0.85s ease forwards; } /* 0.5s -> 0.85s */

        .result-card h5 {
            font-size: 1rem; color: #fff; font-weight: 700; margin: 0 0 0.4rem;
        }
        .desc {
            font-size: 0.9rem; line-height: 1.4; color: #ddd; margin: 0.2rem 0 0;
        }

        /* 제목 줄(좌: 제목 / 우: 기관 + 상태) */
        .title-row { display:flex; align-items:center; justify-content:space-between; gap: 8px; }
        .meta { display:flex; align-items:center; gap: 8px; }
        .agency { font-size: 0.8rem; color: #bbb; white-space: nowrap; }

        /* 상태 아이콘 */
        .status { width: 24px; height: 24px; display:flex; align-items:center; justify-content:center; }
        .spinner {
            border: 3px solid rgba(255,255,255,0.1);
            border-top: 3px solid #0d6efd;
            border-radius: 50%;
            width: 20px; height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg);} 100% { transform: rotate(360deg);} }
        .check { color: #0d6efd; font-size: 1.2rem; line-height: 1; }

        /* 제외된 카드 오버레이 */
        .result-card-wrapper { position: relative; }
        .excluded-overlay {
            position: absolute; inset: 0;
            background: rgba(0,0,0,0.6);
            border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            color: #ff6b6b; font-weight: bold; font-size: 0.9rem;
            opacity: 0; transition: opacity 0.3s ease;
            pointer-events: none; /* 오버레이 위에서도 클릭 통과 */
        }
        .result-card.excluded .excluded-overlay { opacity: 1; }

        /* 로딩 영역 토글 */
        .loader {
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top: 4px solid #0d6efd;
            border-radius: 50%;
            width: 40px; height: 40px;
            animation: spin 1s linear infinite;
            margin: 1rem auto;
        }
        .hidden { display: none !important; }

        .alert { border-radius: 8px; padding: 1rem; margin-top: 1rem; font-size: 0.9rem; }
        .alert-warning { background:#333; color:#ffda6a; }
        .alert-danger  { background:#333; color:#ff6b6b; }
    </style>
</head>
<body>

<header>
    <div class="logo">Sub One</div>
    <div class="user-info">
        <img th:src="${user.profile_image_url}" alt="프로필">
        <span th:text="${user.nickname}">사용자</span>
    </div>
</header>

<main class="main-content">
    <div class="search-box">
        <h2>내 지역 재난지원금 찾기</h2>
        <p>거주지 주소를 입력하고 지원 가능한 재난지원금을 확인하세요.</p>

        <div class="input-group">
            <input type="text" id="address-input" class="form-control" placeholder="먼저 주소 검색 버튼을 클릭하세요" readonly>
            <button class="btn btn-outline-secondary" type="button" id="search-address-btn">주소 검색</button>
        </div>
        <button class="btn btn-primary" id="find-relief-btn">재난지원금 조회하기</button>
    </div>

    <div class="results-container mt-4">
        <div id="loading-spinner" class="text-center hidden">
            <div class="loader"></div>
        </div>
        <div id="results-list"></div>
    </div>
</main>

<script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
<script>
    // 주소 검색
    document.getElementById('search-address-btn').addEventListener('click', function () {
        new daum.Postcode({
            oncomplete: function(data) {
                document.getElementById('address-input').value = data.address;
            }
        }).open();
    });

    // 조회 버튼
    document.getElementById('find-relief-btn').addEventListener('click', function() {
        const address = document.getElementById('address-input').value;
        if (!address) { alert('주소를 먼저 검색해주세요.'); return; }

        const loadingSpinner = document.getElementById('loading-spinner');
        const resultsList = document.getElementById('results-list');
        loadingSpinner.classList.remove('hidden');
        resultsList.innerHTML = '';

        fetchDisasterReliefData(address)
            .then(data => {
                loadingSpinner.classList.add('hidden');
                displayResults(data);
            })
            .catch(error => {
                loadingSpinner.classList.add('hidden');
                resultsList.innerHTML = `<div class="alert alert-danger">데이터를 불러오는 중 오류가 발생했습니다.</div>`;
                console.error(error);
            });
    });

    // 샘플 데이터 (항상 6개로 맞춤)
    function fetchDisasterReliefData(address) {
        return new Promise((resolve) => {
            setTimeout(() => {
                let sampleData = [
                    { title: "긴급재난지원금",           agency: "행정안전부",   description: "코로나19 위기 극복을 위한 전 국민 대상 지원금입니다." },
                    { title: "농작물재해보험", agency: "행정안전부", description: "농작물재해보험은 자연재해(태풍, 가뭄, 냉해 등)로 인한 피해 보상금을 지급받는 공적 보험제도." },
                    { title: "산불재난 지원금",        agency: "행정안전부",   description: "일상 회복을 보조하기 위한 정부 및 지방자치단체의 긴급 생활보조." },
                    { title: "풍수해·지진재해보험",      agency: "행정안전부",   description: "국민은 저렴한 보험료로 예기치 못한 풍수해·지진재해." },
                    { title: "지역 소상공인 회복지원금",     agency: "지자체",      description: "지역 경기 침체 완화를 위한 소상공인 맞춤형 지원금." },
                    { title: "저소득층 긴급복지지원",       agency: "보건복지부",   description: "위기상황 저소득층 가구에 생계·의료·주거비 긴급 지원." }
                ];

                if (address.includes('서울')) {
                    sampleData.unshift({
                        title: "[서울시] 서울 희망지원금",
                        agency: "서울특별시청",
                        description: "서울시민 생활 안정을 돕기 위해 서울시가 별도로 지급하는 지원금입니다."
                    });
                    sampleData = sampleData.slice(0, 6); // 항상 6개 유지
                }
                resolve(sampleData);
            }, 1000);
        });
    }

    // 결과 표시 (순차 애니메·4초 스피너·제외 오버레이)
    function displayResults(data) {
        const resultsList = document.getElementById('results-list');
        resultsList.innerHTML = '';

        if (data.length === 0) {
            resultsList.innerHTML = `<div class="alert alert-warning">해당 지역 지원금 정보가 없습니다.</div>`;
            return;
        }

        data.forEach((item, index) => {
            const wrapper = document.createElement("div");
            wrapper.className = "result-card-wrapper";

            const card = document.createElement("div");
            card.className = "result-card";

            // 상단: 제목(좌) — [기관, 상태](우)
            card.innerHTML = `
        <div class="title-row">
          <h5>${item.title}</h5>
          <div class="meta">
            <span class="agency">${item.agency}</span>
            <span class="status"><div class="spinner"></div></span>
          </div>
        </div>
        <p class="desc">${item.description}</p>
        <div class="excluded-overlay">해당 지원금은 해당되지 않아요</div>
      `;

            // 카드 클릭 → 상세
            card.addEventListener('click', () => {
                goToDetail(
                    encodeURIComponent(item.title),
                    encodeURIComponent(item.agency),
                    encodeURIComponent(item.description)
                );
            });

            wrapper.appendChild(card);
            resultsList.appendChild(wrapper);

            // 순차 등장 (간격 0.5s로 느리게)
            setTimeout(() => {
                card.classList.add("show");

                // 상태 처리: 4초 동안 스피너 → 체크 (2초 → 4초)
                const status = card.querySelector(".status");
                setTimeout(() => {
                    status.innerHTML = `<span class="check">&#10003;</span>`;

                    // 제외 대상: 맨 위 1개, 맨 아래 2개
                    if (index === 0 || index === data.length - 1 || index === data.length - 2) {
                        card.classList.add("excluded");
                    }
                }, 4000);

            }, index * 500); // 300ms → 500ms
        });
    }

    // 상세 페이지 이동
    function goToDetail(title, agency, description) {
        const url = `/relief-detail?title=${title}&agency=${agency}&description=${description}`;
        window.location.href = url;
    }
</script>

</body>
</html>
